<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®é˜²å¾¡ - æœåŠ¡å™¨ä¿å«æˆ˜</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #0a0a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #game-container {
            width: 800px;
            height: 600px;
            margin: 20px auto;
            position: relative;
            background-color: #111;
            border: 2px solid #33a;
            box-shadow: 0 0 20px #33a;
            overflow: hidden;
        }
        
        #server {
            position: absolute;
            top: 50%;
            left: 50%;
            /* transform: translate(-50%, -50%); */
            width: 100px;
            height: 150px;
            background: linear-gradient(to bottom, #444, #222);
            border: 2px solid #0f0;
            box-shadow: 0 0 10px #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .server-light {
            width: 10px;
            height: 10px;
            background-color: #0f0;
            border-radius: 50%;
            margin: 5px;
            animation: blink 1s infinite;
        }
        
        .firewall {
            position: absolute;
            width: 300px;
            height: 300px;
            border: 2px dashed #0ff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: rotate 20s linear infinite;
        }
        
        .hacker {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #f00;
            border-radius: 50%;
            z-index: 10;
            /* transition: transform 0.3s ease; */
        }
        
        .hacker.elite {
            background-color: #f80;
            width: 25px;
            height: 25px;
            box-shadow: 0 0 10px #f80;
        }
        
        .hacker.boss {
            background-color: #f0f;
            width: 35px;
            height: 35px;
            box-shadow: 0 0 20px #f0f;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from { box-shadow: 0 0 10px #f0f; }
            to { box-shadow: 0 0 30px #f0f; }
        }
        
        .defense {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #0f0;
            border-radius: 50%;
            z-index: 5;
            transition: background-color 0.3s, transform 0.3s;
        }
        
        .defense-range {
            position: absolute;
            border: 1px dashed rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            z-index: 4;
            pointer-events: none;
        }
        
        .defense.tier2 {
            background-color: #0ff;
            transform: scale(1.2);
        }
        
        .defense.tier3 {
            background-color: #00f;
            transform: scale(1.4);
            box-shadow: 0 0 10px #00f;
        }
        
        .defense-effect {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(0, 255, 0, 0.7);
            border-radius: 50%;
            z-index: 6;
            animation: expand 0.5s forwards;
            pointer-events: none;
        }
        
        @keyframes expand {
            from { transform: scale(0); opacity: 1; }
            to { transform: scale(3); opacity: 0; }
        }
        
        .data-packet {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #0f0;
            border-radius: 2px;
            z-index: 7;
            animation: data-glow 1s infinite alternate;
        }
        
        @keyframes data-glow {
            from { box-shadow: 0 0 3px #0f0; }
            to { box-shadow: 0 0 8px #0f0; }
        }
        
        #controls {
            margin: 20px auto;
            width: 800px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 20px;
            background-color: #224;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin: 5px;
            position: relative;
        }
        
        .control-btn:hover {
            background-color: #336;
            transform: translateY(-2px);
        }
        
        .control-btn:active {
            transform: translateY(1px);
        }
        
        .control-btn:disabled {
            background-color: #333;
            color: #777;
            cursor: not-allowed;
            transform: none;
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-size: 12px;
            width: 200px;
            z-index: 100;
        }
        
        .control-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        #defense-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #33a;
            display: none;
        }
        
        .defense-option {
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        .defense-option:hover {
            background-color: #224;
        }
        
        .defense-option.selected {
            background-color: #336;
            border: 1px solid #0ff;
        }
        
        #defense-info {
            margin-top: 5px;
            font-size: 12px;
            color: #0ff;
        }
        
        #stats {
            width: 800px;
            margin: 20px auto;
            display: flex;
            justify-content: space-between;
            background-color: #224;
            padding: 10px;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            padding: 5px 10px;
            background-color: #112;
            border-radius: 3px;
            margin: 2px;
            font-family: 'Courier New', monospace;
            color: #0f0;
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        #message {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #ff0;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 5px #ff0;
            z-index: 50;
        }
        
        #message-log {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            max-height: 100px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #33a;
            border-radius: 5px;
            padding: 5px;
            font-size: 12px;
            z-index: 50;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px;
            border-bottom: 1px solid #224;
        }
        
        .log-entry.warning {
            color: #f80;
        }
        
        .log-entry.danger {
            color: #f00;
        }
        
        .log-entry.success {
            color: #0f0;
        }
        
        #game-over, #level-complete {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #game-over h1 {
            color: #f00;
            font-size: 40px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #f00;
        }
        
        #level-complete h1 {
            color: #0f0;
            font-size: 40px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0f0;
        }
        
        .result-info {
            color: #0ff;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .game-btn {
            padding: 10px 20px;
            background-color: #090;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            margin: 10px;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .game-btn:hover {
            background-color: #0b0;
            transform: scale(1.05);
        }
        
        #tutorial {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 101;
        }
        
        #tutorial-content {
            width: 80%;
            max-height: 80%;
            overflow-y: auto;
            background-color: #112;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #0ff;
        }
        
        #tutorial h2 {
            color: #0ff;
            margin-bottom: 15px;
        }
        
        .tutorial-section {
            margin-bottom: 15px;
        }
        
        .tutorial-section h3 {
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .tutorial-image {
            width: 100px;
            height: 60px;
            background-color: #224;
            margin: 10px;
            display: inline-block;
            border: 1px solid #336;
        }
        
        #progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            background-color: #0f0;
            width: 0%;
            transition: width 0.5s;
        }
        
        .upgrade-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 20, 40, 0.95);
            border: 2px solid #0ff;
            border-radius: 10px;
            padding: 20px;
            z-index: 101;
            width: 70%;
            max-height: 80%;
            overflow-y: auto;
            display: none;
        }
        
        .upgrade-menu h2 {
            color: #0ff;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .upgrade-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #112;
            transition: background-color 0.3s;
        }
        
        .upgrade-item:hover {
            background-color: #224;
        }
        
        .upgrade-icon {
            width: 40px;
            height: 40px;
            background-color: #336;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 20px;
        }
        
        .upgrade-info {
            flex-grow: 1;
        }
        
        .upgrade-name {
            font-weight: bold;
            color: #0f0;
        }
        
        .upgrade-description {
            font-size: 12px;
            color: #ccc;
        }
        
        .upgrade-cost {
            color: #ff0;
            font-weight: bold;
        }
        
        .upgrade-button {
            padding: 5px 10px;
            background-color: #060;
            border: none;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .upgrade-button:hover {
            background-color: #090;
        }
        
        .upgrade-button:disabled {
            background-color: #333;
            color: #777;
            cursor: not-allowed;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        #notification {
            position: absolute;
            pointer-events: none;
            font-weight: bold;
            text-shadow: 0 0 3px black;
            z-index: 30;
            animation: float-up 1.5s forwards;
        }
        
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        .wave-indicator {
            position: absolute;
            top: 50px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #f00;
            color: #f00;
            z-index: 20;
            animation: pulse-border 1s infinite alternate;
        }
        
        @keyframes pulse-border {
            from { border-color: #f00; }
            to { border-color: #ff0; }
        }
        
        .special-effect {
            position: absolute;
            pointer-events: none;
            z-index: 25;
        }

    </style>
</head>
<body>
    <div id="game-container">
        <div id="server">
            <div class="server-light"></div>
            <div class="server-light"></div>
            <div class="server-light"></div>
        </div>
        <div class="firewall"></div>
        <div id="message"></div>
        <div id="message-log"></div>
        <div id="defense-panel">
            <div class="defense-option selected" data-type="standard">æ ‡å‡†é˜²å¾¡ (5åˆ†)</div>
            <div class="defense-option" data-type="rapid">å¿«é€Ÿååº”é˜²å¾¡ (15åˆ†)</div>
            <div class="defense-option" data-type="area">åŒºåŸŸé˜²å¾¡ (25åˆ†)</div>
            <div id="defense-info">æ ‡å‡†é˜²å¾¡ï¼šåŸºç¡€å‹é˜²å¾¡ç‚¹ï¼Œæœ‰æ•ˆæ‹¦æˆªæ™®é€šé»‘å®¢</div>
        </div>
        <div id="game-over">
            <h1>æœåŠ¡å™¨è¢«æ”»ç ´ï¼</h1>
            <div class="result-info">åšæŒå›åˆæ•°: <span id="survived-waves">0</span></div>
            <div class="result-info">æ€»åˆ†æ•°: <span id="final-score">0</span></div>
            <div class="result-info">æ‹¦æˆªé»‘å®¢æ•°: <span id="hackers-stopped">0</span></div>
            <button class="game-btn" id="restart-btn">é‡æ–°å¼€å§‹</button>
            <button class="game-btn" id="tutorial-btn">æŸ¥çœ‹æ•™ç¨‹</button>
        </div>
        <div id="level-complete">
            <h1>å…³å¡å®Œæˆï¼</h1>
            <div class="result-info">æœåŠ¡å™¨å®‰å…¨åº¦: <span id="remaining-security">0</span>%</div>
            <div class="result-info">è·å¾—å¥–åŠ±åˆ†æ•°: <span id="bonus-score">0</span></div>
            <button class="game-btn" id="next-level-btn">å‰å¾€ä¸‹ä¸€å…³</button>
            <button class="game-btn" id="upgrade-btn">å‡çº§ç³»ç»Ÿ</button>
        </div>
        <div id="tutorial">
            <div id="tutorial-content">
                <h2>æ•°æ®é˜²å¾¡ - æ¸¸æˆæ•™ç¨‹</h2>
                
                <div class="tutorial-section">
                    <h3>æ¸¸æˆç›®æ ‡</h3>
                    <p>ä¿æŠ¤ä¸­å¤®æœåŠ¡å™¨ä¸è¢«é»‘å®¢æ”»ç ´ï¼ŒåšæŒå°½å¯èƒ½å¤šçš„æ³¢æ¬¡æ”»å‡»ï¼Œè·å¾—é«˜åˆ†ï¼</p>
                </div>
                
                <div class="tutorial-section">
                    <h3>é»‘å®¢ç±»å‹</h3>
                    <p><span style="color: #f00;">â—</span> æ™®é€šé»‘å®¢ - é€Ÿåº¦ä¸­ç­‰ï¼Œä¼¤å®³è¾ƒå°</p>
                    <p><span style="color: #f80;">â—</span> ç²¾è‹±é»‘å®¢ - é€Ÿåº¦è¾ƒå¿«ï¼Œä¼¤å®³ä¸­ç­‰ï¼Œæ›´éš¾è¢«æ‹¦æˆª</p>
                    <p><span style="color: #f0f;">â—</span> é»‘å®¢é¦–é¢† - é€Ÿåº¦æ…¢ï¼Œä¼¤å®³å·¨å¤§ï¼Œéœ€è¦å¤šæ¬¡æ”»å‡»æ‰èƒ½æ¶ˆç­</p>
                </div>
                
                <div class="tutorial-section">
                    <h3>é˜²å¾¡ç³»ç»Ÿ</h3>
                    <p><span style="color: #0f0;">â—</span> æ ‡å‡†é˜²å¾¡ - åŸºç¡€é˜²å¾¡ç‚¹ï¼Œæˆæœ¬ä½</p>
                    <p><span style="color: #0ff;">â—</span> å¿«é€Ÿååº”é˜²å¾¡ - æ”»å‡»é€Ÿåº¦æ›´å¿«ï¼ŒèŒƒå›´å°</p>
                    <p><span style="color: #00f;">â—</span> åŒºåŸŸé˜²å¾¡ - å¤§èŒƒå›´é˜²å¾¡ï¼Œå¯åŒæ—¶æ”»å‡»å¤šä¸ªç›®æ ‡</p>
                    <p>ç‚¹å‡»æ¸¸æˆåŒºåŸŸæ”¾ç½®é˜²å¾¡ç‚¹ï¼Œä½¿ç”¨å³ä¸Šè§’é¢æ¿åˆ‡æ¢é˜²å¾¡ç±»å‹</p>
                </div>
                
                <div class="tutorial-section">
                    <h3>ç‰¹æ®ŠåŠŸèƒ½</h3>
                    <p>å¼ºåŒ–é˜²ç«å¢™ - å‡ç¼“é»‘å®¢ç§»åŠ¨é€Ÿåº¦</p>
                    <p>å®‰å…¨æ‰«æ - éšæœºæ¸…é™¤é»‘å®¢</p>
                    <p>ç³»ç»Ÿè¡¥ä¸ - æ¢å¤æœåŠ¡å™¨å®‰å…¨åº¦</p>
                    <p>ç´§æ€¥å‡€åŒ– - æ¶ˆé™¤å±å¹•ä¸Šæ‰€æœ‰æ™®é€šé»‘å®¢</p>
                    <p>æ•°æ®åŠ å¯† - çŸ­æ—¶é—´å†…æé«˜é˜²å¾¡æ•ˆæœ</p>
                    <p>æ”¶é›†æ•°æ®åŒ… - è·å–é¢å¤–åˆ†æ•°å’Œå‡çº§ç‚¹æ•°</p>
                </div>
                
                <div class="tutorial-section">
                    <h3>æ³¢æ¬¡ç³»ç»Ÿ</h3>
                    <p>æ¯ä¸ªå…³å¡æœ‰å¤šä¸ªæ³¢æ¬¡çš„é»‘å®¢æ”»å‡»</p>
                    <p>æ³¢æ¬¡ä¹‹é—´æœ‰çŸ­æš‚ä¼‘æ¯æ—¶é—´</p>
                    <p>å®Œæˆæ‰€æœ‰æ³¢æ¬¡åå¯ä»¥è¿›å…¥ä¸‹ä¸€å…³</p>
                </div>
            </div>
            <button class="game-btn" id="close-tutorial-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
        <div id="upgrade-menu" class="upgrade-menu">
            <h2>ç³»ç»Ÿå‡çº§</h2>
            <div id="upgrade-list"></div>
            <button class="close-btn" id="close-upgrade-btn">âœ•</button>
        </div>
        <div id="progress-bar"></div>
    </div>
    
    <div id="stats">
        <div class="stat-box">
            <div class="stat-icon">ğŸ”’</div>
            <div id="level-display">å®‰å…¨ç­‰çº§: 1</div>
        </div>
        <div class="stat-box">
            <div class="stat-icon">ğŸ’°</div>
            <div id="score-display">åˆ†æ•°: 0</div>
        </div>
        <div class="stat-box">
            <div class="stat-icon">ğŸ›¡ï¸</div>
            <div id="security-display">æœåŠ¡å™¨å®‰å…¨: 100%</div>
        </div>
        <!-- è¿™é‡Œæ·»åŠ å®‰å…¨åº¦è¿›åº¦æ¡ -->
        <div class="stat-box" style="width: 100%;">
            <div id="security-bar" style="width: 100%; height: 10px; background-color: #0f0; border-radius: 5px;"></div>
        </div>
        <div class="stat-box">
            <div class="stat-icon">ğŸŒŠ</div>
            <div id="wave-display">æ³¢æ¬¡: 0/5</div>
        </div>
        <div class="stat-box">
            <div class="stat-icon">âš¡</div>
            <div id="upgrade-display">å‡çº§ç‚¹: 0</div>
        </div>
    </div>
    
    
    <div id="controls">
        <button class="control-btn" id="firewall-btn">
            å¼ºåŒ–é˜²ç«å¢™ (10åˆ†)
            <div class="tooltip">å¢å¼ºé˜²ç«å¢™ï¼Œå‡ç¼“æ‰€æœ‰é»‘å®¢çš„ç§»åŠ¨é€Ÿåº¦</div>
        </button>
        <button class="control-btn" id="scan-btn">
            å®‰å…¨æ‰«æ (5åˆ†)
            <div class="tooltip">æ‰§è¡Œå®‰å…¨æ‰«æï¼Œéšæœºæ¸…é™¤ä¸€ä¸ªé»‘å®¢</div>
        </button>
        <button class="control-btn" id="patch-btn">
            ç³»ç»Ÿè¡¥ä¸ (15åˆ†)
            <div class="tooltip">å®‰è£…å®‰å…¨è¡¥ä¸ï¼Œæ¢å¤æœåŠ¡å™¨å®‰å…¨åº¦</div>
        </button>
        <button class="control-btn" id="purge-btn">
            ç´§æ€¥å‡€åŒ– (30åˆ†)
            <div class="tooltip">æ¸…é™¤å±å¹•ä¸Šæ‰€æœ‰æ™®é€šé»‘å®¢</div>
        </button>
        <button class="control-btn" id="encrypt-btn">
            æ•°æ®åŠ å¯† (20åˆ†)
            <div class="tooltip">ä¸´æ—¶åŠ å¼ºæ‰€æœ‰é˜²å¾¡æ•ˆæœ</div>
        </button>
        <button class="control-btn" id="upgrade-shop-btn">
            å‡çº§å•†åº—
            <div class="tooltip">æ‰“å¼€å‡çº§å•†åº—ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½</div>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameContainer = document.getElementById('game-container');
            const server = document.getElementById('server');
            const message = document.getElementById('message');
            const messageLog = document.getElementById('message-log');
            const levelDisplay = document.getElementById('level-display');
            const scoreDisplay = document.getElementById('score-display');
            const securityDisplay = document.getElementById('security-display');
            const waveDisplay = document.getElementById('wave-display');
            const upgradeDisplay = document.getElementById('upgrade-display');
            const firewallBtn = document.getElementById('firewall-btn');
            const scanBtn = document.getElementById('scan-btn');
            const patchBtn = document.getElementById('patch-btn');
            const purgeBtn = document.getElementById('purge-btn');
            const encryptBtn = document.getElementById('encrypt-btn');
            const upgradeShopBtn = document.getElementById('upgrade-shop-btn');
            const gameOver = document.getElementById('game-over');
            const levelComplete = document.getElementById('level-complete');
            const restartBtn = document.getElementById('restart-btn');
            const nextLevelBtn = document.getElementById('next-level-btn');
            const upgradeBtn = document.getElementById('upgrade-btn');
            const tutorialBtn = document.getElementById('tutorial-btn');
            const tutorial = document.getElementById('tutorial');
            const closeTutorialBtn = document.getElementById('close-tutorial-btn');
            const upgradeMenu = document.getElementById('upgrade-menu');
            const upgradeList = document.getElementById('upgrade-list');
            const closeUpgradeBtn = document.getElementById('close-upgrade-btn');
            const defensePanel = document.getElementById('defense-panel');
            const defenseOptions = document.querySelectorAll('.defense-option');
            const defenseInfo = document.getElementById('defense-info');
            const progressBar = document.getElementById('progress-bar');
            
            let currentDefenseType = 'standard';
            
            // æ¸¸æˆçŠ¶æ€
            let gameState = {
                level: 1,
                score: 0,
                security: 100,
                hackers: [],
                defenses: [],
                dataPackets: [],
                hackerInterval: null,
                gameLoop: null,
                defenseLoop: null,
                packetInterval: null,
                wave: 0,
                maxWaves: 5,
                waveInProgress: false,
                waveTimeout: null,
                upgradePoints: 0,
                hackersDefeated: 0,
                eliteHackersDefeated: 0,
                bossesDefeated: 0,
                encryptionActive: false,
                upgrades: {
                    serverHealth: 0,
                    serverRepair: 0,
                    defenseRange: 0,
                    defenseDamage: 0,
                    defenseRate: 0,
                    resourceGen: 0,
                    packetValue: 0,
                    eliteDefense: 0
                }
            };
            
            // å‡çº§é€‰é¡¹
            const upgradeOptions = [
                {
                    id: 'serverHealth',
                    name: 'æœåŠ¡å™¨å¼ºåŒ–',
                    description: 'å¢åŠ æœåŠ¡å™¨æœ€å¤§å®‰å…¨åº¦',
                    icon: 'ğŸ”‹',
                    cost: function(level) { return 2 + level; },
                    maxLevel: 5,
                    effect: function(level) { return `æœ€å¤§å®‰å…¨åº¦ +${level * 20}%`; }
                },
                {
                    id: 'serverRepair',
                    name: 'è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ',
                    description: 'æœåŠ¡å™¨ä¼šè‡ªåŠ¨ç¼“æ…¢ä¿®å¤',
                    icon: 'ğŸ”§',
                    cost: function(level) { return 3 + level; },
                    maxLevel: 3,
                    effect: function(level) { return `æ¯ç§’ä¿®å¤ ${level * 0.5}% å®‰å…¨åº¦`; }
                },
                {
                    id: 'defenseRange',
                    name: 'å¢å¼ºé˜²å¾¡èŒƒå›´',
                    description: 'å¢åŠ æ‰€æœ‰é˜²å¾¡ç‚¹çš„èŒƒå›´',
                    icon: 'ğŸ“¡',
                    cost: function(level) { return 2 + level; },
                    maxLevel: 5,
                    effect: function(level) { return `é˜²å¾¡èŒƒå›´ +${level * 15}%`; }
                },
                {
                    id: 'defenseDamage',
                    name: 'æ”»å‡»å¼ºåŒ–',
                    description: 'å¢åŠ é˜²å¾¡ç‚¹çš„æ”»å‡»ä¼¤å®³',
                    icon: 'âš”ï¸',
                    cost: function(level) { return 3 + level; },
                    maxLevel: 5,
                    effect: function(level) { return `é˜²å¾¡ä¼¤å®³ +${level * 25}%`; }
                },
                {
                    id: 'defenseRate',
                    name: 'æ”»å‡»é€Ÿåº¦',
                    description: 'æé«˜é˜²å¾¡ç‚¹çš„æ”»å‡»é¢‘ç‡',
                    icon: 'âš¡',
                    cost: function(level) { return 2 + level * 2; },
                    maxLevel: 3,
                    effect: function(level) { return `æ”»å‡»é€Ÿåº¦ +${level * 20}%`; }
                },
                {
                    id: 'resourceGen',
                    name: 'èµ„æºç”Ÿæˆ',
                    description: 'éšæ—¶é—´è‡ªåŠ¨è·å¾—é¢å¤–åˆ†æ•°',
                    icon: 'ğŸ’°',
                    cost: function(level) { return 3 + level * 2; },
                    maxLevel: 3,
                    effect: function(level) { return `æ¯ç§’è·å¾— ${level * 0.5} åˆ†`; }
                },
                {
                    id: 'packetValue',
                    name: 'æ•°æ®åŒ…å¢å¼º',
                    description: 'å¢åŠ æ•°æ®åŒ…çš„ä»·å€¼',
                    icon: 'ğŸ“¦',
                    cost: function(level) { return 1 + level; },
                    maxLevel: 5,
                    effect: function(level) { return `æ•°æ®åŒ…ä»·å€¼ +${level * 25}%`; }
                },
                {
                   id: 'eliteDefense',
                     name: 'ç²¾è‹±é˜²å¾¡',
                     description: 'é˜²å¾¡ç‚¹æœ‰å‡ ç‡å‡çº§ä¸ºæ›´å¼ºå¤§çš„å½¢æ€',
                      icon: 'ğŸ’',
                     cost: function(level) { return 3 + level * 2; },
                     maxLevel: 3,
                 effect: function(level) { return `é˜²å¾¡ç‚¹æœ‰ ${level * 10}% å‡ ç‡å‡çº§åˆ°ä¸‹ä¸€çº§`; }
                }
            ];

// åˆå§‹åŒ–æ¸¸æˆ
function initGame() {
    gameState = {
        level: 1,
        score: 0,
        security: 100,
        hackers: [],
        defenses: [],
        dataPackets: [],
        hackerInterval: null,
        gameLoop: null,
        defenseLoop: null,
        packetInterval: null,
        wave: 0,
        maxWaves: 5,
        waveInProgress: false,
        waveTimeout: null,
        upgradePoints: 0,
        hackersDefeated: 0,
        eliteHackersDefeated: 0,
        bossesDefeated: 0,
        encryptionActive: false,
        upgrades: {
            serverHealth: 0,
            serverRepair: 0,
            defenseRange: 0,
            defenseDamage: 0,
            defenseRate: 0,
            resourceGen: 0,
            packetValue: 0,
            eliteDefense: 0
        }
    };
    
    updateDisplay();
    clearElements();
    startGame();
}

// æ¸…é™¤æ‰€æœ‰å…ƒç´ 
function clearElements() {
    // æ¸…é™¤é»‘å®¢
    gameState.hackers.forEach(hacker => {
        if (hacker.element) {
            hacker.element.remove();
        }
    });
    gameState.hackers = [];
    
    // æ¸…é™¤é˜²å¾¡ç‚¹
    gameState.defenses.forEach(defense => {
        if (defense.element) {
            defense.element.remove();
        }
        if (defense.rangeElement) {
            defense.rangeElement.remove();
        }
    });
    gameState.defenses = [];
    
    // æ¸…é™¤æ•°æ®åŒ…
    gameState.dataPackets.forEach(packet => {
        if (packet.element) {
            packet.element.remove();
        }
    });
    gameState.dataPackets = [];
    
    // æ¸…é™¤ç‰¹æ•ˆ
    document.querySelectorAll('.defense-effect, .special-effect, .wave-indicator, #notification').forEach(el => {
        el.remove();
    });
}

// å¼€å§‹æ¸¸æˆ
function startGame() {
    // æ¸…é™¤ä¹‹å‰çš„é—´éš”å’Œè®¡æ—¶å™¨
    clearInterval(gameState.hackerInterval);
    clearInterval(gameState.gameLoop);
    clearInterval(gameState.defenseLoop);
    clearInterval(gameState.packetInterval);
    clearTimeout(gameState.waveTimeout);
    
    // åˆå§‹åŒ–æ¸¸æˆå¾ªç¯
    gameState.gameLoop = setInterval(gameLoop, 16);
    gameState.defenseLoop = setInterval(defenseLoop, 1000);
    
    // å¼€å§‹ç¬¬ä¸€æ³¢
    startWave();
    
    // å¯åŠ¨æ•°æ®åŒ…ç”Ÿæˆ
    gameState.packetInterval = setInterval(generateDataPacket, 10000);
    
    // å¦‚æœæœ‰èµ„æºç”Ÿæˆå‡çº§ï¼Œå¯åŠ¨èµ„æºç”Ÿæˆ
    if (gameState.upgrades.resourceGen > 0) {
        setInterval(() => {
            addScore(0.5 * gameState.upgrades.resourceGen);
        }, 1000);
    }
    
    // å¦‚æœæœ‰æœåŠ¡å™¨ä¿®å¤å‡çº§ï¼Œå¯åŠ¨è‡ªåŠ¨ä¿®å¤
    if (gameState.upgrades.serverRepair > 0) {
        setInterval(() => {
            if (gameState.security < 100 + (gameState.upgrades.serverHealth * 20)) {
                gameState.security += 0.5 * gameState.upgrades.serverRepair;
                if (gameState.security > 100 + (gameState.upgrades.serverHealth * 20)) {
                    gameState.security = 100 + (gameState.upgrades.serverHealth * 20);
                }
                updateDisplay();
            }
        }, 1000);
    }
}

// ä¸»æ¸¸æˆå¾ªç¯
function gameLoop() {
    moveHackers();
    updateDisplay();
    
    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
    if (gameState.security <= 0) {
        endGame();
    }
}

// é˜²å¾¡å¾ªç¯
function defenseLoop() {
    gameState.defenses.forEach(defense => {
        attackNearbyHackers(defense);
    });
}

// å¼€å§‹æ–°ä¸€æ³¢
function startWave() {
    gameState.wave++;
    if (gameState.wave > gameState.maxWaves) {
        completeLevel();
        return;
    }
    
    gameState.waveInProgress = true;
    updateDisplay();
    showMessage(`ç¬¬ ${gameState.wave} æ³¢é»‘å®¢æ”»å‡»å¼€å§‹ï¼`, 'warning');
    
    // æ˜¾ç¤ºæ³¢æ¬¡æŒ‡ç¤ºå™¨
    const waveIndicator = document.createElement('div');
    waveIndicator.className = 'wave-indicator';
    waveIndicator.textContent = `æ­£åœ¨è¿›è¡Œ: ç¬¬ ${gameState.wave} æ³¢`;
    gameContainer.appendChild(waveIndicator);
    
    // æ ¹æ®å½“å‰æ³¢æ¬¡å’Œçº§åˆ«ç¡®å®šç”Ÿæˆé»‘å®¢çš„é¢‘ç‡å’Œç±»å‹
    const baseInterval = 2000 - (gameState.level * 100) - (gameState.wave * 150);
    const interval = Math.max(baseInterval, 500);
    
    // æ ¹æ®æ³¢æ¬¡å’Œçº§åˆ«ç¡®å®šé»‘å®¢æ•°é‡
    const hackerCount = 5 + gameState.level + gameState.wave * 2;
    let hackersSpawned = 0;
    
    // ç”Ÿæˆé»‘å®¢
    gameState.hackerInterval = setInterval(() => {
        if (hackersSpawned >= hackerCount) {
            clearInterval(gameState.hackerInterval);
            
            // æ³¢æ¬¡ç»“æŸåçš„ä¼‘æ¯æ—¶é—´
            gameState.waveTimeout = setTimeout(() => {
                gameState.waveInProgress = false;
                waveIndicator.remove();
                showMessage('é»‘å®¢æ”»å‡»æš‚åœï¼Œå‡†å¤‡ä¸‹ä¸€æ³¢', 'success');
                
                // çŸ­æš‚ä¼‘æ¯åå¼€å§‹ä¸‹ä¸€æ³¢
                gameState.waveTimeout = setTimeout(() => {
                    startWave();
                }, 10000);
            }, 5000);
            return;
        }
        
        // ç¡®å®šé»‘å®¢ç±»å‹
        let hackerType = 'normal';
        const rand = Math.random();
        
        if (gameState.level >= 3 && gameState.wave >= 3 && rand < 0.05) {
            hackerType = 'boss';
        } else if ((gameState.level >= 2 || gameState.wave >= 3) && rand < 0.2) {
            hackerType = 'elite';
        }
        
        spawnHacker(hackerType);
        hackersSpawned++;
    }, interval);
}

// ç”Ÿæˆé»‘å®¢
function spawnHacker(type = 'normal') {
    // éšæœºä½ç½®ï¼ˆå±å¹•è¾¹ç¼˜ï¼‰
    let x, y;
    const edge = Math.floor(Math.random() * 4);
    
    switch (edge) {
        case 0: // ä¸Šè¾¹ç¼˜
            x = Math.random() * gameContainer.offsetWidth;
            y = 0;
            break;
        case 1: // å³è¾¹ç¼˜
            x = gameContainer.offsetWidth;
            y = Math.random() * gameContainer.offsetHeight;
            break;
        case 2: // ä¸‹è¾¹ç¼˜
            x = Math.random() * gameContainer.offsetWidth;
            y = gameContainer.offsetHeight;
            break;
        case 3: // å·¦è¾¹ç¼˜
            x = 0;
            y = Math.random() * gameContainer.offsetHeight;
            break;
    }
    
    // é»‘å®¢å±æ€§
    let health, speed, damage, className;
    
    switch (type) {
        case 'elite':
            health = 2 + Math.floor(gameState.level / 2);
            speed = 0.7 + (gameState.level * 0.1);
            damage = 5 + gameState.level;
            className = 'hacker elite';
            break;
        case 'boss':
            health = 5 + gameState.level * 2;
            speed = 0.3 + (gameState.level * 0.05);
            damage = 15 + gameState.level * 3;
            className = 'hacker boss';
            break;
        default:
            health = 1;
            speed = 0.5 + (gameState.level * 0.08);
            damage = 3 + Math.floor(gameState.level / 2);
            className = 'hacker';
    }
    
    // åˆ›å»ºé»‘å®¢å…ƒç´ 
    const hackerElement = document.createElement('div');
    hackerElement.className = className;
    hackerElement.style.left = `${x}px`;
    hackerElement.style.top = `${y}px`;
    gameContainer.appendChild(hackerElement);
    
    // æ·»åŠ åˆ°é»‘å®¢æ•°ç»„
    gameState.hackers.push({
        element: hackerElement,
        x: x,
        y: y,
        type: type,
        health: health,
        speed: speed,
        damage: damage,
        slowFactor: 1
    });
}

// ç§»åŠ¨é»‘å®¢
function moveHackers() {
    const serverRect = server.getBoundingClientRect();
    const containerRect = gameContainer.getBoundingClientRect();
    
    const serverCenterX = serverRect.left - containerRect.left + serverRect.width / 2;
    const serverCenterY = serverRect.top - containerRect.top + serverRect.height / 2;
    
    gameState.hackers.forEach((hacker, index) => {
        // è®¡ç®—åˆ°æœåŠ¡å™¨çš„æ–¹å‘
        const dx = serverCenterX - hacker.x;
        const dy = serverCenterY - hacker.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // å¦‚æœåˆ°è¾¾æœåŠ¡å™¨
        if (distance < 30) {
            // æ”»å‡»æœåŠ¡å™¨
            gameState.security -= hacker.damage;
            
            // åˆ›å»ºæ”»å‡»æ•ˆæœ
            createSpecialEffect(hacker.x, hacker.y, 'serverAttack');
            
            // ç§»é™¤é»‘å®¢
            hacker.element.remove();
            gameState.hackers.splice(index, 1);
            
            showMessage(`æœåŠ¡å™¨é­å—æ”»å‡»ï¼å®‰å…¨åº¦ -${hacker.damage}`, 'danger');
            return;
        }
        
        // ç§»åŠ¨æœå‘æœåŠ¡å™¨
        const moveSpeed = (hacker.speed / hacker.slowFactor) * (gameState.encryptionActive ? 0.7 : 1);
        const moveX = (dx / distance) * moveSpeed;
        const moveY = (dy / distance) * moveSpeed;
        
        hacker.x += moveX;
        hacker.y += moveY;
        
        // æ›´æ–°é»‘å®¢ä½ç½®
        hacker.element.style.left = `${hacker.x}px`;
        hacker.element.style.top = `${hacker.y}px`;
        
        // æ…¢æ…¢æ¢å¤æ­£å¸¸é€Ÿåº¦ï¼ˆå¦‚æœè¢«é˜²ç«å¢™å‡é€Ÿï¼‰
        if (hacker.slowFactor > 1) {
            hacker.slowFactor -= 0.01;
            if (hacker.slowFactor < 1) {
                hacker.slowFactor = 1;
            }
        }
    });
}

// é˜²å¾¡ç‚¹æ”»å‡»é™„è¿‘çš„é»‘å®¢
function attackNearbyHackers(defense) {
    if (gameState.hackers.length === 0) return;
    
    // è®¡ç®—æ”»å‡»é—´éš”
    const baseInterval = defense.baseInterval || 1000;
    const attackInterval = baseInterval / (1 + (gameState.upgrades.defenseRate * 0.2));
    
    // æ£€æŸ¥æ˜¯å¦å·²å‡†å¤‡å¥½æ”»å‡»
    const now = Date.now();
    if (now - defense.lastAttack < attackInterval) return;
    
    // æ ¹æ®é˜²å¾¡ç±»å‹ç¡®å®šæ”»å‡»èŒƒå›´å’Œæ”»å‡»æ•°
    let range = defense.range;
    let maxTargets = defense.type === 'area' ? 3 : 1;
    
    // åº”ç”¨é˜²å¾¡èŒƒå›´å‡çº§
    range *= (1 + (gameState.upgrades.defenseRange * 0.15));
    
    // å¯»æ‰¾èŒƒå›´å†…çš„é»‘å®¢
    const targets = [];
    gameState.hackers.forEach(hacker => {
        const dx = hacker.x - defense.x;
        const dy = hacker.y - defense.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance <= range) {
            targets.push({
                hacker: hacker,
                distance: distance
            });
        }
    });
    
    // æŒ‰è·ç¦»æ’åº
    targets.sort((a, b) => a.distance - b.distance);
    
    // æ”»å‡»æœ€è¿‘çš„é»‘å®¢
    const attackedTargets = targets.slice(0, maxTargets);
    if (attackedTargets.length > 0) {
        attackedTargets.forEach(target => {
            attackHacker(defense, target.hacker);
        });
        defense.lastAttack = now;
    }
}

// æ”»å‡»é»‘å®¢
function attackHacker(defense, hacker) {
    // è®¡ç®—åŸºç¡€ä¼¤å®³
    let damage = defense.damage || 1;
    
    // åº”ç”¨ä¼¤å®³å‡çº§
    damage *= (1 + (gameState.upgrades.defenseDamage * 0.25));
    
    // å¦‚æœåŠ å¯†æ¿€æ´»ï¼Œé¢å¤–å¢åŠ ä¼¤å®³
    if (gameState.encryptionActive) {
        damage *= 1.5;
    }
    
    // åˆ›å»ºæ”»å‡»æ•ˆæœ
    const effect = document.createElement('div');
    effect.className = 'defense-effect';
    effect.style.left = `${hacker.x - 15}px`;
    effect.style.top = `${hacker.y - 15}px`;
    gameContainer.appendChild(effect);
    
    // è®¾ç½®æ•ˆæœé¢œè‰²
    if (defense.type === 'rapid') {
        effect.style.backgroundColor = 'rgba(0, 255, 255, 0.7)';
    } else if (defense.type === 'area') {
        effect.style.backgroundColor = 'rgba(0, 0, 255, 0.7)';
    }
    
    // ä¸€æ®µæ—¶é—´åç§»é™¤æ•ˆæœ
    setTimeout(() => {
        effect.remove();
    }, 500);
    
    // é™ä½é»‘å®¢ç”Ÿå‘½å€¼
    hacker.health -= damage;
    
    // æ˜¾ç¤ºä¼¤å®³æ•°å­—
    showNotification(Math.round(damage), hacker.x, hacker.y, '#0f0');
    
    // å¦‚æœé»‘å®¢è¢«æ¶ˆç­
    if (hacker.health <= 0) {
        // è®°å½•å‡»è´¥æ•°é‡
        gameState.hackersDefeated++;
        if (hacker.type === 'elite') {
            gameState.eliteHackersDefeated++;
        } else if (hacker.type === 'boss') {
            gameState.bossesDefeated++;
        }
        
        // å¥–åŠ±åˆ†æ•°
        let scoreBonus = 0;
        switch (hacker.type) {
            case 'elite':
                scoreBonus = 15 + gameState.level * 2;
                break;
            case 'boss':
                scoreBonus = 50 + gameState.level * 5;
                break;
            default:
                scoreBonus = 5 + Math.floor(gameState.level / 2);
        }
        
        // æ·»åŠ åˆ†æ•°
        addScore(scoreBonus);
        
        // æ˜¾ç¤ºå¾—åˆ†
        showNotification(`+${scoreBonus}`, hacker.x, hacker.y, '#ff0');
        
        // ç§»é™¤é»‘å®¢
        const index = gameState.hackers.indexOf(hacker);
        if (index !== -1) {
            hacker.element.remove();
            gameState.hackers.splice(index, 1);
        }
        
        // æ·»åŠ å‡çº§ç‚¹æ•°
        if (hacker.type === 'elite' || hacker.type === 'boss') {
            addUpgradePoints(1);
        }
        
        // æœ‰å‡ ç‡æ‰è½æ•°æ®åŒ…
        if (Math.random() < 0.3) {
            createDataPacket(hacker.x, hacker.y);
        }
    }
}

// å¼ºåŒ–é˜²ç«å¢™
function enhanceFirewall() {
    const cost = 10;
    if (gameState.score < cost) {
        showMessage('åˆ†æ•°ä¸è¶³ï¼Œæ— æ³•å¼ºåŒ–é˜²ç«å¢™', 'warning');
        return;
    }
    
    addScore(-cost);
    showMessage('é˜²ç«å¢™å·²å¼ºåŒ–ï¼Œé»‘å®¢ç§»åŠ¨å‡ç¼“', 'success');
    
    // å‡ç¼“æ‰€æœ‰é»‘å®¢é€Ÿåº¦
    gameState.hackers.forEach(hacker => {
        hacker.slowFactor = 2;
    });
    
    // è§†è§‰æ•ˆæœ
    const firewall = document.querySelector('.firewall');
    firewall.style.borderColor = '#00f';
    firewall.style.animation = 'rotate 10s linear infinite';
    
    setTimeout(() => {
        firewall.style.borderColor = '#0ff';
        firewall.style.animation = 'rotate 20s linear infinite';
    }, 10000);
}

// å®‰å…¨æ‰«æ
function securityScan() {
    const cost = 5;
    if (gameState.score < cost) {
        showMessage('åˆ†æ•°ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œå®‰å…¨æ‰«æ', 'warning');
        return;
    }
    
    if (gameState.hackers.length === 0) {
        showMessage('æ²¡æœ‰æ£€æµ‹åˆ°é»‘å®¢', 'warning');
        return;
    }
    
    addScore(-cost);
    
    // éšæœºé€‰æ‹©ä¸€ä¸ªé»‘å®¢
    const index = Math.floor(Math.random() * gameState.hackers.length);
    const hacker = gameState.hackers[index];
    
    // åˆ›å»ºæ‰«ææ•ˆæœ
    createSpecialEffect(hacker.x, hacker.y, 'scan');
    
    setTimeout(() => {
        if (gameState.hackers.indexOf(hacker) !== -1) {
            hacker.element.remove();
            gameState.hackers.splice(index, 1);
            showMessage('å®‰å…¨æ‰«ææˆåŠŸæ¸…é™¤ä¸€ä¸ªé»‘å®¢', 'success');
            
            // å¥–åŠ±
            if (hacker.type === 'boss') {
                addScore(10);
                addUpgradePoints(1);
            }
        }
    }, 500);
}

// ç³»ç»Ÿè¡¥ä¸
function systemPatch() {
    const cost = 15;
    if (gameState.score < cost) {
        showMessage('åˆ†æ•°ä¸è¶³ï¼Œæ— æ³•å®‰è£…ç³»ç»Ÿè¡¥ä¸', 'warning');
        return;
    }
    
    addScore(-cost);
    
    // æ¢å¤å®‰å…¨åº¦
    const maxSecurity = 100 + (gameState.upgrades.serverHealth * 20);
    const repairAmount = 20 + gameState.level * 2;
    gameState.security += repairAmount;
    
    if (gameState.security > maxSecurity) {
        gameState.security = maxSecurity;
    }
    
    showMessage(`ç³»ç»Ÿè¡¥ä¸å·²å®‰è£…ï¼ŒæœåŠ¡å™¨å®‰å…¨åº¦ +${repairAmount}`, 'success');
    
    // è§†è§‰æ•ˆæœ
    server.style.boxShadow = '0 0 30px #0f0';
    setTimeout(() => {
        server.style.boxShadow = '0 0 10px #0f0';
    }, 1000);
}

// ç´§æ€¥å‡€åŒ–
function emergencyPurge() {
    const cost = 30;
    if (gameState.score < cost) {
        showMessage('åˆ†æ•°ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œç´§æ€¥å‡€åŒ–', 'warning');
        return;
    }
    
    addScore(-cost);
    
    // æ¸…é™¤æ‰€æœ‰æ™®é€šé»‘å®¢
    let removed = 0;
    for (let i = gameState.hackers.length - 1; i >= 0; i--) {
        if (gameState.hackers[i].type === 'normal') {
            createSpecialEffect(gameState.hackers[i].x, gameState.hackers[i].y, 'purge');
            gameState.hackers[i].element.remove();
            gameState.hackers.splice(i, 1);
            removed++;
        }
    }
    
    if (removed > 0) {
        showMessage(`ç´§æ€¥å‡€åŒ–å·²æ‰§è¡Œï¼Œæ¸…é™¤äº† ${removed} ä¸ªæ™®é€šé»‘å®¢`, 'success');
    } else {
        showMessage('æ²¡æœ‰æ£€æµ‹åˆ°æ™®é€šé»‘å®¢', 'warning');
    }
}

// æ•°æ®åŠ å¯†
function dataEncryption() {
    const cost = 20;
    if (gameState.score < cost) {
        showMessage('åˆ†æ•°ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ•°æ®åŠ å¯†', 'warning');
        return;
    }
    
    if (gameState.encryptionActive) {
        showMessage('æ•°æ®åŠ å¯†å·²ç»å¤„äºæ¿€æ´»çŠ¶æ€', 'warning');
        return;
    }
    
    addScore(-cost);
    gameState.encryptionActive = true;
    
    showMessage('æ•°æ®åŠ å¯†å·²æ¿€æ´»ï¼Œé˜²å¾¡æ•ˆæœæå‡', 'success');
    
    // è§†è§‰æ•ˆæœ
    gameState.defenses.forEach(defense => {
        defense.element.style.boxShadow = '0 0 15px #ff0';
    });
    
    // æŒç»­30ç§’
    setTimeout(() => {
        gameState.encryptionActive = false;
        showMessage('æ•°æ®åŠ å¯†æ•ˆæœå·²ç»“æŸ', 'warning');
        
        gameState.defenses.forEach(defense => {
            if (defense.type === 'standard') {
                defense.element.style.boxShadow = '';
            } else if (defense.type === 'rapid') {
                defense.element.style.boxShadow = '0 0 10px #0ff';
            } else if (defense.type === 'area') {
                defense.element.style.boxShadow = '0 0 10px #00f';
            }
        });
    }, 30000);
}

// åˆ›å»ºæ•°æ®åŒ…
function createDataPacket(x, y) {
    const packetElement = document.createElement('div');
    packetElement.className = 'data-packet';
    
    // å¦‚æœæ²¡æœ‰æŒ‡å®šä½ç½®ï¼Œéšæœºç”Ÿæˆ
    if (x === undefined || y === undefined) {
        x = Math.random() * (gameContainer.offsetWidth - 50) + 25;
        y = Math.random() * (gameContainer.offsetHeight - 50) + 25;
    }
    
    packetElement.style.left = `${x}px`;
    packetElement.style.top = `${y}px`;
    gameContainer.appendChild(packetElement);
    
    const packet = {
        element: packetElement,
        x: x,
        y: y,
        value: 5 * (1 + (gameState.upgrades.packetValue * 0.25)),
        collected: false
    };
    
    gameState.dataPackets.push(packet);
    
    // ç‚¹å‡»æ•°æ®åŒ…æ”¶é›†
    packetElement.addEventListener('click', () => {
        collectDataPacket(packet);
    });
    
    // ä¸€æ®µæ—¶é—´åæ¶ˆå¤±
    setTimeout(() => {
        if (gameState.dataPackets.indexOf(packet) !== -1 && !packet.collected) {
            const index = gameState.dataPackets.indexOf(packet);
            if (index !== -1) {
                packet.element.remove();
                gameState.dataPackets.splice(index, 1);
            }
        }
    }, 15000);
}

// éšæœºç”Ÿæˆæ•°æ®åŒ…
function generateDataPacket() {
    // åªæœ‰åœ¨æ³¢æ¬¡è¿›è¡Œä¸­æ‰ç”Ÿæˆæ•°æ®åŒ…
    if (gameState.waveInProgress) {
        createDataPacket();
    }
}

// æ”¶é›†æ•°æ®åŒ…
function collectDataPacket(packet) {
    if (packet.collected) return;
    
    packet.collected = true;
    packet.element.remove();
    
    // ç§»é™¤æ•°æ®åŒ…
    const index = gameState.dataPackets.indexOf(packet);
    if (index !== -1) {
        gameState.dataPackets.splice(index, 1);
    }
    
    // å¥–åŠ±åˆ†æ•°
    addScore(packet.value);
    
    // è§†è§‰æ•ˆæœ
    showNotification(`+${Math.round(packet.value)}`, packet.x, packet.y, '#0ff');
    
    // æœ‰å‡ ç‡è·å¾—å‡çº§ç‚¹
    if (Math.random() < 0.3) {
        addUpgradePoints(1);
        showNotification('+1 å‡çº§ç‚¹', packet.x, packet.y + 20, '#ff0');
    }
}

// æ”¾ç½®é˜²å¾¡ç‚¹
function placeDefense(x, y) {
    // ç¡®å®šæˆæœ¬
    let cost, type, range, damage, attackInterval;
    
    switch (currentDefenseType) {
        case 'rapid':
            cost = 15;
            range = 80;
            damage = 0.8;
            attackInterval = 500;
            break;
        case 'area':
            cost = 25;
            range = 120;
            damage = 0.6;
            attackInterval = 1200;
            break;
        default: // standard
            cost = 5;
            range = 100;
            damage = 1;
            attackInterval = 1000;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿåˆ†æ•°
    if (gameState.score < cost) {
        showMessage(`åˆ†æ•°ä¸è¶³ï¼Œæ— æ³•æ”¾ç½® ${getDefenseTypeName(currentDefenseType)}`, 'warning');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–é˜²å¾¡ç‚¹å¤ªè¿‘
    for (const defense of gameState.defenses) {
        const dx = defense.x - x;
        const dy = defense.y - y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < 40) {
            showMessage('é˜²å¾¡ç‚¹æ”¾ç½®å¤ªè¿‘ï¼Œè¯·é€‰æ‹©å…¶ä»–ä½ç½®', 'warning');
            return;
        }
    }
    
    addScore(-cost);
    
    // åˆ›å»ºé˜²å¾¡ç‚¹å…ƒç´ 
    const defenseElement = document.createElement('div');
    defenseElement.className = 'defense';
    defenseElement.style.left = `${x - 7.5}px`;
    defenseElement.style.top = `${y - 7.5}px`;
    
    // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
    if (currentDefenseType === 'rapid') {
        defenseElement.classList.add('tier2');
    } else if (currentDefenseType === 'area') {
        defenseElement.classList.add('tier3');
    }
    
    gameContainer.appendChild(defenseElement);
    
    // åˆ›å»ºèŒƒå›´æŒ‡ç¤ºå™¨
    const rangeElement = document.createElement('div');
    rangeElement.className = 'defense-range';
    rangeElement.style.left = `${x - range}px`;
    rangeElement.style.top = `${y - range}px`;
    rangeElement.style.width = `${range * 2}px`;
    rangeElement.style.height = `${range * 2}px`;
    gameContainer.appendChild(rangeElement);
    
    // æ˜¾ç¤º/éšè—èŒƒå›´æŒ‡ç¤ºå™¨
    defenseElement.addEventListener('mouseover', () => {
        rangeElement.style.display = 'block';
    });
    
    defenseElement.addEventListener('mouseout', () => {
        rangeElement.style.display = 'none';
    });
    
    // é»˜è®¤éšè—èŒƒå›´æŒ‡ç¤ºå™¨
    rangeElement.style.display = 'none';
    
    // ç²¾è‹±é˜²å¾¡å‡çº§å‡ ç‡
    let tier = (currentDefenseType === 'rapid') ? 2 : (currentDefenseType === 'area' ? 3 : 1);
    if (tier < 3 && gameState.upgrades.eliteDefense > 0) {
        const upgradeChance = gameState.upgrades.eliteDefense * 0.1;
        if (Math.random() < upgradeChance) {
            tier += 1;
            if (tier === 2) {
                defenseElement.classList.add('tier2');
                defenseElement.classList.remove('tier3');
                damage *= 1.2;
                attackInterval *= 0.9;
                showNotification('å‡çº§!', x, y, '#0ff');
            } else if (tier === 3) {
                defenseElement.classList.add('tier3');
                defenseElement.classList.remove('tier2');
                damage *= 1.5;
                range *= 1.2;
                showNotification('ç²¾è‹±å‡çº§!', x, y, '#00f');
            }
        }
    }
    
    // æ·»åŠ åˆ°é˜²å¾¡æ•°ç»„
    gameState.defenses.push({
        element: defenseElement,
        rangeElement: rangeElement,
        x: x,
        y: y,
        type: currentDefenseType,
        range: range,
        damage: damage,
        baseInterval: attackInterval,
        lastAttack: Date.now()
    });
    
    showMessage(`å·²æ”¾ç½® ${getDefenseTypeName(currentDefenseType)}`, 'success');
}

// è·å–é˜²å¾¡ç±»å‹åç§°
function getDefenseTypeName(type) {
    switch (type) {
        case 'rapid':
            return 'å¿«é€Ÿååº”é˜²å¾¡';
        case 'area':
            return 'åŒºåŸŸé˜²å¾¡';
        default:
            return 'æ ‡å‡†é˜²å¾¡';
    }
}

// åˆ›å»ºç‰¹æ®Šæ•ˆæœ
function createSpecialEffect(x, y, type) {
    const effect = document.createElement('div');
    effect.className = 'special-effect';
    effect.style.left = `${x - 20}px`;
    effect.style.top = `${y - 20}px`;
    
    switch (type) {
        case 'scan':
            effect.style.width = '40px';
            effect.style.height = '40px';
            effect.style.border = '2px solid #0ff';
            effect.style.borderRadius = '50%';
            effect.style.animation = 'expand 0.5s forwards';
            break;
        case 'purge':
            effect.style.width = '30px';
            effect.style.height = '30px';
            effect.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
            effect.style.borderRadius = '50%';
            effect.style.animation = 'pulse 0.5s forwards';
            break;
        case 'serverAttack':
            effect.style.width = '40px';
            effect.style.height = '40px';
            effect.style.backgroundColor = 'rgba(255, 50, 50, 0.7)';
            effect.style.borderRadius = '50%';
            effect.style.animation = 'flash 0.5s forwards';
            break;
    }
    
    gameContainer.appendChild(effect);
    
    // ä¸€æ®µæ—¶é—´åç§»é™¤æ•ˆæœ
    setTimeout(() => {
        effect.remove();
    }, 1000);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(text, x, y, color = '#fff') {
    const notification = document.createElement('div');
    notification.className = 'floating-notification';
    notification.textContent = text;
    notification.style.left = `${x}px`;
    notification.style.top = `${y}px`;
    notification.style.color = color;
    gameContainer.appendChild(notification);
    
    // åŠ¨ç”»æ•ˆæœ
    setTimeout(() => {
        notification.style.transform = 'translateY(-30px)';
        notification.style.opacity = '0';
    }, 100);
    
    // ç§»é™¤é€šçŸ¥
    setTimeout(() => {
        notification.remove();
    }, 1000);
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(text, type = 'info') {
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = `notification ${type}`;
    notification.textContent = text;
    
    const existing = document.getElementById('notification');
    if (existing) {
        existing.remove();
    }
    
    gameContainer.appendChild(notification);
    
    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 500);
    }, 3000);
}

// æ·»åŠ åˆ†æ•°
function addScore(amount) {
    gameState.score += amount;
    if (gameState.score < 0) gameState.score = 0;
    updateDisplay();
}

// æ·»åŠ å‡çº§ç‚¹æ•°
function addUpgradePoints(amount) {
    gameState.upgradePoints += amount;
    updateDisplay();
}

// å®Œæˆå…³å¡
function completeLevel() {
    clearInterval(gameState.hackerInterval);
    clearTimeout(gameState.waveTimeout);
    
    // å¥–åŠ±
    const bonusPoints = 5 + gameState.level;
    gameState.upgradePoints += bonusPoints;
    
    showMessage(`æ­å–œï¼æ‚¨å®Œæˆäº†ç¬¬ ${gameState.level} å…³ï¼è·å¾— ${bonusPoints} ä¸ªå‡çº§ç‚¹`, 'success');
    
    // å‡çº§åˆ°ä¸‹ä¸€å…³
    gameState.level++;
    gameState.wave = 0;
    gameState.maxWaves = 5 + Math.floor(gameState.level / 2);
    
    // ä¿ç•™å½“å‰é˜²å¾¡ç‚¹å’Œå‡çº§
    setTimeout(() => {
        // æ¸…é™¤æ‰€æœ‰é»‘å®¢å’Œæ•°æ®åŒ…
        gameState.hackers.forEach(hacker => {
            if (hacker.element) {
                hacker.element.remove();
            }
        });
        gameState.hackers = [];
        
        gameState.dataPackets.forEach(packet => {
            if (packet.element) {
                packet.element.remove();
            }
        });
        gameState.dataPackets = [];
        
        startWave();
    }, 5000);
}

// æ¸¸æˆç»“æŸ
function endGame() {
    // æ¸…é™¤æ‰€æœ‰é—´éš”
    clearInterval(gameState.hackerInterval);
    clearInterval(gameState.gameLoop);
    clearInterval(gameState.defenseLoop);
    clearInterval(gameState.packetInterval);
    clearTimeout(gameState.waveTimeout);
    
    // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ¶ˆæ¯
    showMessage(`æ¸¸æˆç»“æŸï¼æ‚¨åšæŒåˆ°äº†ç¬¬ ${gameState.level} å…³ï¼Œç¬¬ ${gameState.wave} æ³¢`, 'danger');
    
    // æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
    const statsHtml = `
        <div class="game-over">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>å…³å¡: ${gameState.level}</p>
            <p>å¾—åˆ†: ${Math.round(gameState.score)}</p>
            <p>å‡»è´¥é»‘å®¢: ${gameState.hackersDefeated}</p>
            <p>å‡»è´¥ç²¾è‹±é»‘å®¢: ${gameState.eliteHackersDefeated}</p>
            <p>å‡»è´¥é¦–é¢†: ${gameState.bossesDefeated}</p>
            <button id="restart-button">é‡æ–°å¼€å§‹</button>
        </div>
    `;
    
    const statsEl = document.createElement('div');
    statsEl.className = 'stats-overlay';
    statsEl.innerHTML = statsHtml;
    document.body.appendChild(statsEl);
    
    // é‡æ–°å¼€å§‹æŒ‰é’®
    document.getElementById('restart-button').addEventListener('click', () => {
        statsEl.remove();
        initGame();
    });
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    document.getElementById('level-display').textContent = `å…³å¡: ${gameState.level}`;
    document.getElementById('wave-display').textContent = `æ³¢æ¬¡: ${gameState.wave}/${gameState.maxWaves}`;
    document.getElementById('score-display').textContent = `åˆ†æ•°: ${Math.round(gameState.score)}`;
    document.getElementById('security-display').textContent = `å®‰å…¨åº¦: ${Math.round(gameState.security)}`;
    document.getElementById('upgrade-display').textContent = `å‡çº§ç‚¹: ${gameState.upgradePoints}`;
    
    // æ›´æ–°å®‰å…¨åº¦æ¡
    const percentage = (gameState.security / (100 + (gameState.upgrades.serverHealth * 20))) * 100;
    document.getElementById('security-bar').style.width = `${percentage}%`;
    
    // æ ¹æ®å®‰å…¨åº¦æ›´æ”¹é¢œè‰²
    if (percentage > 60) {
        document.getElementById('security-bar').style.backgroundColor = '#0f0';
    } else if (percentage > 30) {
        document.getElementById('security-bar').style.backgroundColor = '#ff0';
    } else {
        document.getElementById('security-bar').style.backgroundColor = '#f00';
    }
}

// æ‰§è¡Œå‡çº§
function applyUpgrade(upgradeId) {
    // è·å–å‡çº§å¯¹è±¡
    const upgrade = upgrades.find(u => u.id === upgradeId);
    if (!upgrade) return;
    
    // å½“å‰ç­‰çº§
    const currentLevel = gameState.upgrades[upgradeId] || 0;
    
    // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°æœ€å¤§ç­‰çº§
    if (currentLevel >= upgrade.maxLevel) {
        showMessage(`${upgrade.name} å·²è¾¾åˆ°æœ€å¤§ç­‰çº§`, 'warning');
        return;
    }
    
    // è®¡ç®—æˆæœ¬
    const cost = typeof upgrade.cost === 'function' ? 
        upgrade.cost(currentLevel) : upgrade.cost;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å‡çº§ç‚¹
    if (gameState.upgradePoints < cost) {
        showMessage(`å‡çº§ç‚¹ä¸è¶³ï¼Œæ— æ³•å‡çº§ ${upgrade.name}`, 'warning');
        return;
    }
    
    // åº”ç”¨å‡çº§
    gameState.upgradePoints -= cost;
    gameState.upgrades[upgradeId] = currentLevel + 1;
    
    showMessage(`å·²å‡çº§ ${upgrade.name} åˆ° ${currentLevel + 1} çº§`, 'success');
    updateDisplay();
    updateUpgradeButtons();
}

// Completing the updateUpgradeButtons function
function updateUpgradeButtons() {
    upgradeOptions.forEach(upgrade => {
        const button = document.getElementById(`upgrade-${upgrade.id}`);
        if (button) {
            const currentLevel = gameState.upgrades[upgrade.id] || 0;
            const cost = typeof upgrade.cost === 'function' ? 
                upgrade.cost(currentLevel) : upgrade.cost;
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            button.textContent = `${upgrade.name} (${currentLevel}/${upgrade.maxLevel}) - ${cost} ç‚¹`;
            
            // æ›´æ–°æ•ˆæœæè¿°
            const effectElement = document.getElementById(`effect-${upgrade.id}`);
            if (effectElement) {
                const effect = typeof upgrade.effect === 'function' ? 
                    upgrade.effect(currentLevel + 1) : upgrade.effect;
                effectElement.textContent = effect;
            }
            
            // ç¦ç”¨å·²è¾¾åˆ°æœ€å¤§ç­‰çº§æˆ–ç‚¹æ•°ä¸è¶³çš„æŒ‰é’®
            if (currentLevel >= upgrade.maxLevel || gameState.upgradePoints < cost) {
                button.disabled = true;
                button.classList.add('disabled');
            } else {
                button.disabled = false;
                button.classList.remove('disabled');
            }
        }
    });
}

// æ˜¾ç¤ºå‡çº§èœå•
function showUpgradeMenu() {
    upgradeMenu.style.display = 'block';
    
    // æ¸…é™¤ç°æœ‰å†…å®¹
    upgradeList.innerHTML = '';
    
    // æ·»åŠ å‡çº§é€‰é¡¹
    upgradeOptions.forEach(upgrade => {
        const currentLevel = gameState.upgrades[upgrade.id] || 0;
        const cost = typeof upgrade.cost === 'function' ? 
            upgrade.cost(currentLevel) : upgrade.cost;
        const effect = typeof upgrade.effect === 'function' ? 
            upgrade.effect(currentLevel + 1) : upgrade.effect;
        
        const item = document.createElement('div');
        item.className = 'upgrade-item';
        
        const header = document.createElement('div');
        header.className = 'upgrade-header';
        
        const icon = document.createElement('span');
        icon.className = 'upgrade-icon';
        icon.textContent = upgrade.icon;
        
        const title = document.createElement('h3');
        title.textContent = upgrade.name;
        
        const level = document.createElement('span');
        level.className = 'upgrade-level';
        level.textContent = `${currentLevel}/${upgrade.maxLevel}`;
        
        header.appendChild(icon);
        header.appendChild(title);
        header.appendChild(level);
        
        const desc = document.createElement('p');
        desc.className = 'upgrade-desc';
        desc.textContent = upgrade.description;
        
        const effectElem = document.createElement('p');
        effectElem.className = 'upgrade-effect';
        effectElem.id = `effect-${upgrade.id}`;
        effectElem.textContent = effect;
        
        const button = document.createElement('button');
        button.id = `upgrade-${upgrade.id}`;
        button.className = 'button';
        button.textContent = `å‡çº§ - ${cost} ç‚¹`;
        
        // ç¦ç”¨å·²è¾¾åˆ°æœ€å¤§ç­‰çº§æˆ–ç‚¹æ•°ä¸è¶³çš„æŒ‰é’®
        if (currentLevel >= upgrade.maxLevel || gameState.upgradePoints < cost) {
            button.disabled = true;
            button.classList.add('disabled');
        }
        
        // ç‚¹å‡»å‡çº§
        button.addEventListener('click', () => {
            applyUpgrade(upgrade.id);
        });
        
        item.appendChild(header);
        item.appendChild(desc);
        item.appendChild(effectElem);
        item.appendChild(button);
        
        upgradeList.appendChild(item);
    });
}

// å…³é—­å‡çº§èœå•
function closeUpgradeMenu() {
    upgradeMenu.style.display = 'none';
}

// æ˜¾ç¤ºé˜²å¾¡ç±»å‹é€‰æ‹©é¢æ¿
function toggleDefensePanel() {
    if (defensePanel.style.display === 'flex') {
        defensePanel.style.display = 'none';
    } else {
        defensePanel.style.display = 'flex';
        updateDefenseInfo();
    }
}

// æ›´æ–°é˜²å¾¡ä¿¡æ¯
function updateDefenseInfo() {
    let name, desc, cost;
    
    switch (currentDefenseType) {
        case 'rapid':
            name = 'å¿«é€Ÿååº”é˜²å¾¡';
            desc = 'æ›´å¿«çš„æ”»å‡»é€Ÿåº¦ï¼Œä½†èŒƒå›´å’Œä¼¤å®³ç•¥ä½';
            cost = '15åˆ†';
            break;
        case 'area':
            name = 'åŒºåŸŸé˜²å¾¡';
            desc = 'å¯ä»¥åŒæ—¶æ”»å‡»å¤šä¸ªç›®æ ‡ï¼ŒèŒƒå›´å¤§ä½†æ”»å‡»é¢‘ç‡ä½';
            cost = '25åˆ†';
            break;
        default:
            name = 'æ ‡å‡†é˜²å¾¡';
            desc = 'åŸºç¡€é˜²å¾¡å•ä½ï¼Œæ€§ä»·æ¯”é«˜';
            cost = '5åˆ†';
    }
    
    defenseInfo.innerHTML = `
        <h3>${name}</h3>
        <p>${desc}</p>
        <p>æˆæœ¬: ${cost}</p>
    `;
}

// åˆ‡æ¢é˜²å¾¡ç±»å‹
function setDefenseType(type) {
    currentDefenseType = type;
    defenseOptions.forEach(option => {
        option.classList.remove('selected');
    });
    document.getElementById(`defense-${type}`).classList.add('selected');
    updateDefenseInfo();
}

// æ˜¾ç¤ºæ•™ç¨‹
function showTutorial() {
    tutorial.style.display = 'block';
}

// å…³é—­æ•™ç¨‹
function closeTutorial() {
    tutorial.style.display = 'none';
}

// åˆå§‹è®¾ç½®
window.onload = function() {
    // è®¾ç½®æ¸¸æˆå®¹å™¨å°ºå¯¸
    gameContainer.style.width = `${window.innerWidth * 0.95}px`;
    gameContainer.style.height = `${window.innerHeight * 0.80}px`;
    
    // è®¾ç½®æœåŠ¡å™¨ä½ç½®
    server.style.left = `${gameContainer.offsetWidth / 2 - server.offsetWidth / 2}px`;
    server.style.top = `${gameContainer.offsetHeight / 2 - server.offsetHeight / 2}px`;
    
    // æ·»åŠ é˜²å¾¡ç±»å‹é€‰æ‹©äº‹ä»¶
    defenseOptions.forEach(option => {
        option.addEventListener('click', () => {
            const type = option.getAttribute('data-type');
            setDefenseType(type);
        });
    });
    
    // æ·»åŠ æ¸¸æˆæ§åˆ¶æŒ‰é’®äº‹ä»¶
    firewallBtn.addEventListener('click', enhanceFirewall);
    scanBtn.addEventListener('click', securityScan);
    patchBtn.addEventListener('click', systemPatch);
    purgeBtn.addEventListener('click', emergencyPurge);
    encryptBtn.addEventListener('click', dataEncryption);
    upgradeShopBtn.addEventListener('click', showUpgradeMenu);
    closeUpgradeBtn.addEventListener('click', closeUpgradeMenu);
    restartBtn.addEventListener('click', initGame);
    nextLevelBtn.addEventListener('click', startWave);
    upgradeBtn.addEventListener('click', toggleDefensePanel);
    tutorialBtn.addEventListener('click', showTutorial);
    closeTutorialBtn.addEventListener('click', closeTutorial);
    
    // ç‚¹å‡»æ¸¸æˆåŒºåŸŸæ”¾ç½®é˜²å¾¡
    gameContainer.addEventListener('click', (e) => {
        // å¿½ç•¥åœ¨å…¶ä»–å…ƒç´ ä¸Šçš„ç‚¹å‡»
        if (e.target !== gameContainer && !e.target.classList.contains('game-container')) {
            return;
        }
        
        // è·å–ç‚¹å‡»ä½ç½®ç›¸å¯¹äºæ¸¸æˆå®¹å™¨çš„åæ ‡
        const rect = gameContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // æ”¾ç½®é˜²å¾¡
        placeDefense(x, y);
    });
    
    // åŠ è½½æ•™ç¨‹æç¤º
    setTimeout(showTutorial, 1000);
    
    // å¼€å§‹æ¸¸æˆ
    initGame();
};

// æ·»åŠ é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case '1':
            setDefenseType('standard');
            break;
        case '2':
            setDefenseType('rapid');
            break;
        case '3':
            setDefenseType('area');
            break;
        case 'f':
            enhanceFirewall();
            break;
        case 's':
            securityScan();
            break;
        case 'p':
            systemPatch();
            break;
        case 'c':
            emergencyPurge();
            break;
        case 'e':
            dataEncryption();
            break;
        case 'u':
            showUpgradeMenu();
            break;
        case 'Escape':
            closeUpgradeMenu();
            closeTutorial();
            defensePanel.style.display = 'none';
            break;
        case 'h':
            if (tutorial.style.display === 'block') {
                closeTutorial();
            } else {
                showTutorial();
            }
            break;
    }
});

// å¤„ç†çª—å£å¤§å°å˜åŒ–
window.addEventListener('resize', () => {
    gameContainer.style.width = `${window.innerWidth * 0.95}px`;
    gameContainer.style.height = `${window.innerHeight * 0.80}px`;
    
    // é‡æ–°å®šä½æœåŠ¡å™¨
    server.style.left = `${gameContainer.offsetWidth / 2 - server.offsetWidth / 2}px`;
    server.style.top = `${gameContainer.offsetHeight / 2 - server.offsetHeight / 2}px`;
});

// é˜²æ­¢å³é”®èœå•
// window.addEventListener('contextmenu', (e) => {
//     e.preventDefault();
// });

// é˜²æ­¢æ‹–åŠ¨å›¾ç‰‡
// document.addEventListener('dragstart', (e) => {
//     e.preventDefault();
// });
 });

    </script>
</body>
</html>
